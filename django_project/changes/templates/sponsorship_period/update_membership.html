{% extends "project_base.html" %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% block title %}
    Sustaining Member Period
{% endblock title %}
{% block extra_head %}
    {{ Other }}
    <script type="text/javascript"
            src="{{ STATIC_URL }}js/jquery.formset.min.js"></script>
    {{ floppyforms }}

{% endblock %}

{% block css_head %}
    <link rel="stylesheet" href="{% static 'css/datepicker.css' %}">
    <style>
        .level-title {
            padding-top: 5px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .recurring-checkbox {
            font-size: 17px;
            font-weight: bold;
        }

    </style>
{% endblock css_head %}

{% block js_head %}
    <script src="{% static 'js/datepicker.js' %}"></script>
    <script src="{% static 'js/i18n/datepicker.en.js' %}"></script>
{% endblock %}

{% block content %}
    <script>
        $(function () {
        });
    </script>

    <section id="forms">
        <div class='container'>
            <form method="post" id="period-form">
            {% csrf_token %}
            <h2>Update Sustaining Member Period for {{ member }}</h2>
            <hr/>
            <div class="alert alert-info alert-data">
                Your membership will runs from <strong>{{ date_start }}</strong> to <strong>{{ date_end }}</strong>
            </div>
            <input type="hidden" name="recurring">
            <div class="panel panel-default panel-level" data-id="{{ level.id }}">
                <div class="panel-body">
                    <div class="col-lg-1 col-xs-4">
                        <img src="{{ level.logo.url }}" width="100%">
                    </div>
                    <div class="col-lg-11 col-xs-8">
                        <div class="level-title">
                            {{ level.name }}
                        </div>
                        <div class="level-amount">
                            {{ level.value }} {{ level.currency }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group recurring-checkbox">
                <label class="checkbox-inline"><input type="checkbox" id="recurring" style="margin-top: 6px;" {% if recurring %}checked{% endif %}>Charge me yearly</label>
            </div>
            <div class="vertical-space"></div>
             {{ form|crispy }}
            </form>
        </div>

    </section>

    <div class="container">
        <button disabled name="submit" value="Pay"
                class="btn btn-success" id="submit-save">Update Subscription</button>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="exampleModalLabel">Are you sure?</h3>
                    <button type="button" class="close close-modal"
                            data-dismiss="modal" aria-label="Close" disabled>
                    <span aria-hidden="true"
                          style="position: absolute; margin-top: -25px; margin-left: -10px;">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="font-size: 16px; padding-top: 40px; padding-bottom: 40px;">
                    Do you really want to update your subscription?
                </div>
                <div class="modal-footer">
                    <button data-dismiss="modal" type="button" class="btn btn-default close-modal"
                            style="padding-left: 40px; padding-right: 40px;">Cancel
                    </button>
                    <button id="submit-subscription" type="button" class="btn btn-success"
                            style="padding-left: 40px; padding-right: 40px;">Yes
                    </button>
                </div>
            </div>
        </div>
    </div>



    <script>
        const $panelLevel = $('.panel-level');
        const $paymentButton = $('#submit-save');
        const $form = $('#period-form');
        const $confirmationModal = $('#confirmationModal');
        const $alert = $('.alert-data');
        const dateStart = '{{ date_start }}';
        const dateEnd = '{{ date_end }}';
        let recurring = {{ recurring|yesno:"true,false" }};
        let selectedLevel = null;

        $(function(){
            $('#div_id_sponsorship_level').hide();
        });

        $('#recurring').change(function() {
            const _recurring = $(this).prop('checked');
            if (_recurring !== recurring) {
                $paymentButton.attr('disabled', false);
            } else {
                $paymentButton.attr('disabled', true);
            }
            if (_recurring) {
                $alert.html(`Your membership will runs <strong>Yearly</strong> from <strong>{{ date_start }}</strong> and will be automatically renewed in <strong>{{ date_end }}</strong>`);
            } else {
                $alert.html(`Your membership will runs from <strong>{{ date_start }}</strong> to <strong>{{ date_end }}</strong>`);
            }
        });

        if (recurring) {
            $('#recurring').change();
        }

        $('#submit-subscription').click(function () {
            $(this).parent().find('.btn').attr('disabled', true);
            $(this).html('Updating...');
            $('.close-modal').hide();
            $form.find('input[name="recurring"]').val($('#recurring').prop('checked'));
            $form.submit();
        });

        $paymentButton.click(function () {
            $confirmationModal.modal('show');
        });

    </script>
{% endblock %}
